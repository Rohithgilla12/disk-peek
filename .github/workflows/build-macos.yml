name: Build macOS

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - arch: universal
            platform: darwin/universal
          - arch: arm64
            platform: darwin/arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build Wails app (${{ matrix.arch }})
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          GIT_COMMIT=$(git rev-parse --short HEAD)
          wails build -platform ${{ matrix.platform }} -clean \
            -ldflags "-X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME} -X main.GitCommit=${GIT_COMMIT}"

      - name: Import Code-Signing Certificates
        uses: Apple-Actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_P12_BASE64 }}
          p12-password: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}

      - name: Sign app bundle
        env:
          SIGNING_IDENTITY: "Developer ID Application: Rohith Gilla (7D2V3RM56T)"
        run: |
          codesign --deep --force --verbose --sign "$SIGNING_IDENTITY" \
            --options runtime \
            --entitlements ./build/darwin/entitlements.plist \
            ./build/bin/disk-peek.app
          codesign --verify --verbose ./build/bin/disk-peek.app

      - name: Notarize app bundle
        env:
          AC_USERNAME: ${{ secrets.AC_USERNAME }}
          AC_PASSWORD: ${{ secrets.AC_PASSWORD }}
          AC_PROVIDER: ${{ secrets.AC_PROVIDER }}
        run: |
          ditto -c -k --keepParent ./build/bin/disk-peek.app ./build/bin/disk-peek.zip
          xcrun notarytool submit ./build/bin/disk-peek.zip \
            --apple-id "$AC_USERNAME" \
            --password "$AC_PASSWORD" \
            --team-id "$AC_PROVIDER" \
            --wait
          xcrun stapler staple ./build/bin/disk-peek.app

      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "Disk Peek" \
            --volicon "build/appicon.png" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "disk-peek.app" 150 185 \
            --app-drop-link 450 185 \
            --no-internet-enable \
            "build/bin/disk-peek-${{ matrix.arch }}.dmg" \
            "build/bin/disk-peek.app"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: disk-peek-macos-${{ matrix.arch }}
          path: |
            build/bin/disk-peek.app
            build/bin/disk-peek-${{ matrix.arch }}.dmg

      - name: Upload to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: build/bin/disk-peek-${{ matrix.arch }}.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
